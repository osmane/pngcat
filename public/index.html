<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PngCat</title>
    <script type="module" src="/components/tag-list.js" defer></script>
    <script src="ul-dropdown.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>

    </style>
</head>

<body>
    <h1>PNG Categorizer</h1>
    <input type="hidden" id="lastSearchAreaId" value="0">
    <input type="hidden" id="jsonTagData" name="sharedTagData" value="PLACEHOLDER">
    <input type="hidden" id="jsonSourceDir" name="sourceDirData" value="PLACEHOLDER">
    <input type="hidden" id="jsonSearchText" name="searchTextData" value="PLACEHOLDER">
    <input type="hidden" id="jsonTargetDir" name="targetDirData" value="PLACEHOLDER">
    <input type="hidden" id="jsonSubTargetDir" name="subTargetDirData" value="PLACEHOLDER">
    <input type="hidden" id="jsonsecondarySearchText" name="secondarySearchTextData" value="PLACEHOLDER">
    <!-- <select id="sourceDirDropdown" style="display:none"></select> -->
    <ul id="sourceDirList" style="display:none"></ul>
    <select id="searchTextDropdown" style="display:none"></select>
    <select id="targetDirDropdown" style="display:none"></select>
    <select id="subTargetDirDropdown" style="display:none"></select>

    <div id="main-props">
        <span>Source Folder Path</span>
        <div class="wrap-inner sd-auto-1">
            <input class="border-none sd-auto-1" id="sourceDir" autocomplete="off" type="text" name="sourceDir">
            <svg class="dropdown-arrow sd-auto-2" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                viewBox="0 0 18 18">
                <path d="M5 8l4 4 4-4z"></path>
            </svg>
        </div>
    </div>

    <div>
    </div>

    <div id="searchAreaContainer">
        <!-- First search area will be placed here -->
    </div>

    <button onclick="addNewSearch()">Add New Search</button>
    <button onclick="startProcessing()">Start Processing</button>
    <div id="fileModal" class="modal" style="display: none;">
        <div class="modal-content">
            <iframe id="fileFrame" src="" width="100%" height="600px"></iframe>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>
    <ul class="dropdown-menu">
        <li>Seçenek 1</li>
        <li>Seçenek 2</li>
        <li>Seçenek 3</li>
    </ul>

    <script>
        (async function () {
            const data = await fetchData();
            document.getElementsByName('sharedTagData')[0].value = data.tags.join(',');
            document.getElementsByName('sourceDirData')[0].value = data.sourceDir.join(',');
            document.getElementsByName('searchTextData')[0].value = data.searchText.join(',');
            document.getElementsByName('targetDirData')[0].value = data.targetDir.join(',');
            document.getElementsByName('subTargetDirData')[0].value = data.subTargetDir.join(',');
            document.getElementsByName('secondarySearchTextData')[0].value = data.secondarySearchText.join(',');
            addNewSearch();
            // initializeUlDropdown();
        })();

        var lastSearchAreaId = parseInt(document.getElementById('lastSearchAreaId').value, 10);

        async function fetchData() {
            try {
                const response = await fetch('/get-data');
                const data = await response.json();
                console.log('Data: ', data);
                return data;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function addNewSearch() {
            const container = document.getElementById('searchAreaContainer');
            const newSearchArea = document.createElement('div');
            newSearchArea.setAttribute('id', 'searchArea-' + lastSearchAreaId);
            newSearchArea.setAttribute('class', 'search-area');
            newSearchArea.innerHTML = `
                <div class="spawnableSearchArea">
                    <div class="flex-container">
                        <div class="flex-item">
                            <!-- Text to Search: 
                            createSDInputBlock('searchText', 'searchText', 'text', 'off', 'Text to Search', '') -->
                            <div>
                                <span>Text to Search</span>    
                                <div class="wrap-inner sd-auto-1">
                                        <input class="border-none sd-auto-1" id="searchText" autocomplete="off" type="text" name="searchText">
                                        <svg class="dropdown-arrow sd-auto-2" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                                            <path d="M5 8l4 4 4-4z"></path>
                                        </svg>
                                </div>
                            </div>
                        </div>
                        <div class="flex-item">
                            <!-- Target Folder: 
                            createSDInputBlock('targetDir', 'targetDir', 'text', 'off', 'Target Folder', '') -->
                            <div>
                                <span>Target Folder</span>    
                                <div class="wrap-inner sd-auto-1">
                                        <input class="border-none sd-auto-1" id="targetDir" autocomplete="off" type="text" name="targetDir">
                                        <svg class="dropdown-arrow sd-auto-2" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                                            <path d="M5 8l4 4 4-4z"></path>
                                        </svg>
                                </div>
                            </div>
                        </div>
                        <div class="flex-item primary-tag-container">
                            <!-- Primary Tags: -->
                            <input type="hidden" name="primaryCustomTags" data-id="${lastSearchAreaId}p">
                        </div>
                    </div>

                    <div class="secondariesContainer">
                        <!-- Secondary search criteria will be placed here -->                        
                    </div>
                    <div>                        
                        <button onclick="addNewSecondaryCriteria(this.closest('.spawnableSearchArea').querySelector('.secondariesContainer'))" style="margin-top: 5px;">Add New Secondary Search Criteria</button>
                        <input type="hidden" id="lastSecondaryCriteriaId" value="0">
                    </div>
                    <div class="sdTagsContainer" style="display: flex;">
                        <div class="checkpointCheckClass">
                            <input type="checkbox" id="checkpointCheckId" name="checkpointCheckName" value="addCheckpoints">
                            <label for="checkpointCheckId">Add Checkpoint name as tag</label>
                        </div>
                        <div class="loraCheckClass">
                            <input type="checkbox" id="loraCheckId" name="loraCheckName" value="addLoras">
                            <label for="loraCheckId">Add LORA names as tag</label>
                        </div>
                    </div>
                    <button class="remove-sa-btn" onclick="removeSearchArea(this.closest('.spawnableSearchArea'))" style="margin-top: 5px;">Remove This Search Area</button>
                    <div class="results" id="results-${lastSearchAreaId}">Processing results will appear here.</div>                                    
                </div>
            `;

            container.appendChild(newSearchArea);


            const primaryContainer = newSearchArea.getElementsByClassName('primary-tag-container')[0];

            loadDynamicComponent(newSearchArea.id, primaryContainer, 0)

            const newSecondariesContainer = newSearchArea.querySelector('.secondariesContainer');

            addNewSecondaryCriteria(newSecondariesContainer);

            document.querySelector('.sd-auto-1').addEventListener('click', () => {
                sourceDirList.style.display = sourceDirList.style.display === 'none' ? 'block' : 'none';
            });

            updateRemoveButtonsVisibility();

            lastSearchAreaId++;

            document.getElementById('lastSearchAreaId').value = lastSearchAreaId;

            initializeUlDropdown()

            // document.dispatchEvent(new CustomEvent('searchAreaLoaded'));
        }

        function loadDynamicComponent(searchAreaId, container, order) {
            const idName = 'tagList-' + searchAreaId + '-order-' + order;
            const className = container.classList.contains('secondary-tag-container') ? "tag-list-class secondary-tag-list" : "tag-list-class primary-tag-list";
            const subject = container.classList.contains('secondary-tag-container') ? "Secondary Tags:" : "Primary Tags:";
            const taglistHTML = `
                            <div>
                                <span>${subject}</span>    
                                <div class="wrap-inner sd-auto-1">
                                    <tag-list class="${className}" id ="${idName}" type="tag-list" name="tag-list">                                         
                                </div>
                            </div>
            `
            container.insertAdjacentHTML('beforeend', taglistHTML);
        }

        function updateTagHistory(tagHistory) {

            const sharedHistoryTags = document.getElementsByName('sharedTagData')[0].value.split(',');
            if (!this.arraysEqual(tagHistory, sharedHistoryTags)) {
                document.getElementsByName('sharedTagData')[0].value = tagHistory.join(',');

                const event = new CustomEvent('tagsHistoryUpdated', { detail: tagHistory });
                window.dispatchEvent(event);
            }

        }

        function updateLocalSelectedTags(selectedTags, dataEl) {
            if (selectedTags && selectedTags.length > 0) {
                dataEl.value = selectedTags.join(',');
                dataEl.closest('.flex-item').querySelector('.wrap-inner').style.borderColor = '';
                var mandaRelatedInput;
                if (dataEl.name === 'primaryCustomTags') {
                    mandaRelatedInput = dataEl.closest('.flex-container').querySelector('#targetDir')
                } else {
                    mandaRelatedInput = dataEl.closest('.flex-container').querySelector('#subTargetDir');
                }
                mandaRelatedInput.closest('.wrap-inner').style.borderColor = '';
            } else {
                dataEl.value = '';
            }

            const event = new CustomEvent('selectedTagsUpdated', { detail: selectedTags });
            window.dispatchEvent(event);
        }

        function arraysEqual(a, b) {
            return a.length === b.length && a.every((val, index) => val === b[index]);
        }

        function removeSearchArea(searchArea) {
            if (document.querySelectorAll('.spawnableSearchArea').length > 1) {
                const searchAreaToBeRemoved = event.target.closest('.search-area');
                searchAreaToBeRemoved.remove();
            }
            updateRemoveButtonsVisibility()
        }

        function updateRemoveButtonsVisibility() {
            // Check all remove buttons and hide the button if there's only one search area
            document.querySelectorAll('.spawnableSearchArea').forEach(area => {
                const removeButton = area.querySelector('.remove-sa-btn');
                removeButton.style.display = document.querySelectorAll('.spawnableSearchArea').length > 1 ? 'block' : 'none';
            });
        }

        function hasRequiredField(sourceDir) {
            var searchAreas = document.querySelectorAll('[id^="searchArea-"]');
            var allFieldsValid = true;
            
            if (!sourceDir.value || (sourceDir.value.trim() === '')) {
                sourceDir.closest('.wrap-inner').style.borderColor = 'red';
                mandatoryFieldsFilled = false;
                allFieldsValid = false;
            } 
                searchAreas.forEach(function (searchArea) {
                    var mandatoryFieldsFilled = true;

                    var inputs = searchArea.querySelectorAll('input[type="text"]');

                    var primaryCustomTags = searchArea.querySelector('input[name="primaryCustomTags"]');
                    var primaryTagListWrap = searchArea.querySelector('.primary-tag-list').closest('.wrap-inner');
                    var targetDir = searchArea.querySelector('input[name="targetDir"]');

                    inputs.forEach(function (input) {
                        if ((input.name === 'sourceDir') || (input.name === 'searchText') || input.name.includes('secondarySearchText')) {
                            if (!input.value || (input.value.trim() === '')) {
                                input.closest('.wrap-inner').style.borderColor = 'red';
                                mandatoryFieldsFilled = false;
                                allFieldsValid = false;
                            }
                        }
                    });

                    if ((!primaryCustomTags || !primaryCustomTags.value || primaryCustomTags.value.trim() === '') &&
                        (!targetDir.value || targetDir.value.trim() === '')) {
                        targetDir.closest('.wrap-inner').style.borderColor = 'red';
                        primaryTagListWrap.style.borderColor = 'red';
                        mandatoryFieldsFilled = false;
                        allFieldsValid = false;
                    }

                    if (searchArea.querySelector('.secondariesContainer div')) {
                        var secondaries = document.querySelectorAll('.secondariesContainer div.secondary');
                        secondaries.forEach(function (secondary) {
                            var secondaryCustomTags = secondary.querySelector('input[name="secondaryCustomTags[]"]');
                            var subTargetDir = secondary.querySelector('input[name="subTargetDir[]"]');
                            var secondaryTagListWrap = secondary.querySelector('.secondary-tag-list').closest('.wrap-inner');

                            if ((!secondaryCustomTags || !secondaryCustomTags.value || secondaryCustomTags.value.trim() === '') &&
                                (!subTargetDir.value || subTargetDir.value.trim() === '')) {
                                subTargetDir.closest('.wrap-inner').style.borderColor = 'red';
                                secondaryTagListWrap.style.borderColor = 'red';
                                mandatoryFieldsFilled = false;
                                allFieldsValid = false;
                            }
                        });                        
                    }
                });
            

            if (!allFieldsValid) {
                console.log('Please fill in all required fields!');
            }

            return allFieldsValid;
        }

        function startProcessing() {
            var sourceDirInput = document.body.querySelectorAll('input[name="sourceDir"]')[0];
            const sourceDir = sourceDirInput.value;

            if (!hasRequiredField(sourceDirInput)) {
                return false;
            }

            const searchParams = collectSearchParams();
            const jsonObj = {};
            const jsonTagValues = document.getElementsByName('sharedTagData')[0].value;
            jsonObj["tags"] = jsonTagValues ? jsonTagValues.split(',') : [];
            jsonObj["tags"] = jsonObj["tags"].sort();
            const jsonData = jsonTagValues ? jsonObj : null;

            fetch('/process-files', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ sourceDir, searchParams, jsonData }),
            })
                .then(response => response.json())
                .then(data => {
                    displayResults(data.results);
                })
                .catch(error => {
                    console.error('Error:', error);
                });

            
            const valueSearchText = document.getElementById('jsonSearchText').value;
            const valueTargetDir = document.getElementById('jsonTargetDir').value;
            const valueSubTargetDir = document.getElementById('jsonSubTargetDir').value;
            const valuesecondarySearchText = document.getElementById('jsonsecondarySearchText').value;

            jsonObj.sourceDir = sourceDir ? sourceDir.split(',') : [];
            jsonObj.searchText = valueSearchText ? valueSearchText.split(',') : [];
            jsonObj.targetDir = valueTargetDir ? valueTargetDir.split(',') : [];
            jsonObj.subTargetDir = valueSubTargetDir ? valueSubTargetDir.split(',') : [];
            jsonObj.secondarySearchText = valuesecondarySearchText ? valuesecondarySearchText.split(',') : [];

            let jsonFileData = fetchData();
            // boş eleman kontrolü buraya gelinmeden yapılmalı
            jsonFileData.tags = Array.from(new Set(jsonObj.tags.concat(jsonFileData.tags)))
                .filter(item => !!item).sort();

            jsonFileData.sourceDir = Array.from(new Set(jsonObj.sourceDir.concat(jsonFileData.sourceDir)))
                .filter(item => !!item).sort();

            jsonFileData.searchText = Array.from(new Set(jsonObj.searchText.concat(jsonFileData.searchText)))
                .filter(item => !!item).sort();

            jsonFileData.targetDir = Array.from(new Set(jsonObj.targetDir.concat(jsonFileData.targetDir)))
                .filter(item => !!item).sort();

            jsonFileData.subTargetDir = Array.from(new Set(jsonObj.subTargetDir.concat(jsonFileData.subTargetDir)))
                .filter(item => !!item).sort();

            jsonFileData.secondarySearchText = Array.from(new Set(jsonObj.secondarySearchText.concat(jsonFileData.secondarySearchText)))
                .filter(item => !!item).sort();

            fetch('/save-lists', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(jsonFileData),
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Data:', data);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function collectSearchParams() {

            const searchAreas = document.querySelectorAll('.spawnableSearchArea');
            return Array.from(searchAreas).map((area, index) => {
                // Collect primary search criteria
                const searchText = area.querySelector('[name="searchText"]').value;
                const targetDir = area.querySelector('[name="targetDir"]').value;

                // Collect secondary search criteria
                const secondarySearchTexts = Array.from(area.querySelectorAll('[name="secondarySearchText[]"]')).map(input => input.value);
                const subTargetDirs = Array.from(area.querySelectorAll('[name="subTargetDir[]"]')).map(input => input.value);
                const secondaryCustomTagArr = Array.from(area.querySelectorAll('[name="secondaryCustomTags[]"]')).map(input => input.value);

                const checkpointChecked = area.querySelector('[name="checkpointCheckName"]').checked ? 'addCheckpoints' : ''
                const loraChecked = area.querySelector('[name="loraCheckName"]').checked ? 'addLoras' : ''


                // Combine secondary search criteria and sub-target directories
                const secondaries = secondarySearchTexts.map((text, i) => ({
                    secondarySearchText: text,
                    subTargetDir: subTargetDirs[i] || '',
                    secondaryCustomTags: secondaryCustomTagArr[i] || '', // Send an empty string if there's no secondary tag
                }));

                // Collect file tags
                const primaryCustomTags = area.querySelector('[name="primaryCustomTags"]').value;
                console.log('index html primaryCustomTags:' + primaryCustomTags + ' secondaryCustomTags:' + secondaryCustomTagArr.join(','))

                return {
                    id: index, // Unique ID for each search area
                    searchText: searchText,
                    targetDir: targetDir,
                    secondaries: secondaries, // Array containing secondary search criteria and sub-target directories
                    primaryCustomTags: primaryCustomTags,
                    checkpointChecked: checkpointChecked,
                    loraChecked: loraChecked,
                };
            });
        }

        function displayResults(results) {
            results.forEach(result => {
                const resultElement = document.getElementById(`results-${result.id}`);
                if (result.error) {
                    resultElement.innerHTML = `Error: ${result.error}`;
                } else {
                    const fileListHtml = result.movedFiles.map(file => {
                        // Use file path text and a unique link generated for the file
                        return `<li><a href="#" class="file-link" data-filepath="/file/${file.fileId}">${file.filePath}</a></li>`;
                    }).join('');

                    resultElement.innerHTML = `
                        <a href="#" onclick="toggleDetails(this)">Total Processed Files: ${result.totalProcessed}</a>
                        <ul id="fileList-${result.id}" style="display: none;">${fileListHtml}</ul>
                    `;
                }
            });
            addClickEventToFileLinks();
        }

        function addNewSecondaryCriteria(container) {
            const newSecondary = document.createElement('div');
            newSecondary.innerHTML = `
                <div style="display: flex;" class="flex-container secondary">
                    <div class="flex-item">
                        <!-- <label>Secondary Text to Search:</label>
                        <input type="text" name="secondarySearchText[]">
                        createSDInputBlock('secondarySearchText[]', 'secondarySearchText', 'text', 'off', 'Secondary Text to Search', '')-->

                        <div>
                            <span>Secondary Text to Search</span>    
                            <div class="wrap-inner sd-auto-1">
                                    <input class="border-none sd-auto-1" id="secondarySearchText" autocomplete="off" type="text" name="secondarySearchText[]">
                                    <svg class="dropdown-arrow sd-auto-2" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                                        <path d="M5 8l4 4 4-4z"></path>
                                    </svg>
                            </div>
                        </div>

                    </div>
                    <div class="flex-item">
                        <!-- <label>Sub-Target Folder:</label>
                        <input type="text" name="subTargetDir[]">
                        createSDInputBlock('subTargetDir[]', 'subTargetDir', 'text', 'off', 'Sub-Target Folder', '')  -->

                        <div>
                            <span>Sub-Target Folder</span>    
                            <div class="wrap-inner sd-auto-1">
                                    <input class="border-none sd-auto-1" id="subTargetDir" autocomplete="off" type="text" name="subTargetDir[]">
                                    <svg class="dropdown-arrow sd-auto-2" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                                        <path d="M5 8l4 4 4-4z"></path>
                                    </svg>
                            </div>
                        </div>

                    </div>
                    <div class="flex-item secondary-tag-container" style="display: flex;">
                        <!-- <label>Secondary Tags:</label> -->
                        <input type="hidden" name="secondaryCustomTags[]"  data-id="${lastSearchAreaId}s">
                    </div>
                    <div class="flex-item">
                        <button onclick="removeThisSecondary(event)" style="margin-top: auto;margin-bottom: auto;" title="Remove This Secondary Search Criteria">Remove</button>
                    </div>
                </div>
            `;


            container.appendChild(newSecondary);
            lastSecondaryCriteriaId = parseInt(document.getElementById('lastSecondaryCriteriaId').value, 10);
            lastSecondaryCriteriaId++;
            document.getElementById('lastSecondaryCriteriaId').value = lastSearchAreaId;

            parentSearchAreaId = container.closest('.search-area').id;
            order = lastSecondaryCriteriaId;
            loadDynamicComponent(parentSearchAreaId, newSecondary.getElementsByClassName('secondary-tag-container')[0], order);

            initializeUlDropdown();
        }

        function removeThisSecondary(event) {
            const secondaryToBeRemoved = event.target.closest('.secondary').closest('div');
            secondaryToBeRemoved.parentNode.remove(secondaryToBeRemoved);
        }

        function toggleDetails(element) {
            const details = element.nextElementSibling; // Find the <ul> element
            details.style.display = details.style.display === "none" ? "block" : "none";
        }

        function openModal(imagePath) {
            const modal = document.getElementById('fileModal');
            modal.style.display = 'flex'; // Make the modal visible

            const frame = document.getElementById('fileFrame');
            // Set the `src` of `iframe` to `image-viewer.html` with query parameter
            frame.src = `image-viewer.html?imagePath=${encodeURIComponent(imagePath)}`;
        }

        function closeModal() {
            const modal = document.getElementById('fileModal');
            modal.style.display = 'none'; // Hide the modal
        }

        function addClickEventToFileLinks() {
            document.querySelectorAll('.file-link').forEach(link => {
                link.addEventListener('click', function (event) {
                    event.preventDefault(); // Prevent the default behavior of the link
                    const filePath = this.getAttribute('data-filepath');
                    openModal(filePath);
                });
            });
        }

        window.onclick = function (event) {
            const modal = document.getElementById('fileModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        window.addEventListener('message', function (event) {
            const modalContent = document.querySelector('.modal-content');
            const iframe = document.getElementById('fileFrame');
            const dimensions = event.data;

            if (iframe && modalContent) {
                // Set maximum width to 80% of available screen space
                const maxWidthPercent = 99; // In percentage
                const maxHeightPercent = 100; // Set height to 100%

                // Calculate maximum width and height while maintaining aspect ratio
                const ratio = dimensions.width / dimensions.height;
                let contentWidthPercent;

                // Calculate width in percentage
                contentWidthPercent = (window.innerHeight * maxWidthPercent / window.innerWidth) * ratio;
                contentWidthPercent = Math.min(contentWidthPercent, maxWidthPercent); // Don't exceed maximum width

                modalContent.style.width = `${contentWidthPercent}%`;
                modalContent.style.height = `${maxHeightPercent}%`;
                modalContent.style.display = 'flex';
                modalContent.style.flexDirection = 'column';
                modalContent.style.justifyContent = 'center';
                modalContent.style.alignItems = 'center';

                iframe.style.width = '100%'; // Set iframe width to match modal-content
                iframe.style.height = '100%'; // Set iframe height to match modal-content
            }
        }, false);



    </script>

</body>

</html>